/app/api/auth/[...nextauth]/route.ts

âœ¨âœ¨ CredentialsProviderë¥¼ í†µí•œ ë¡œê·¸ì¸ 
  - ë°±ì—”ë“œ ì„œë²„ì—ì„œ accessToken, refreshToken ì£¼ëŠ” ê²½ìš°


ğŸˆ NextAuth ë¡œê·¸ì¸(CredentialsProvider)
providers: [
  CredentialsProvider({
    async authorize(credentials) {
      // ë°±ì—”ë“œ ë¡œê·¸ì¸ API í˜¸ì¶œ
      const response = await fetch('YOUR_LOGIN_API', {
        method: 'POST',
        body: JSON.stringify(credentials)
      });
      
      const data = await response.json();
      
      // ë°±ì—”ë“œì—ì„œ ë°›ì€ ë°ì´í„°
      if (data.accessToken) {
        return {
          id: data.id,
          email: data.email,
          accessToken: data.accessToken,
          refreshToken: data.refreshToken
        };
      }
      return null;
    }
  })
]

1-1. authorize()ë¥¼ í†µí•´ ë¡œê·¸ì¸ API ìš”ì²­ì„ í•œë‹¤. ì—¬ê¸°ì„œ bodyëŠ” ì…ë ¥í•œ ì•„ì´ë””, ë¹„ë²ˆì„ ë„˜ê²¨ì¤€ë‹¤.
1-2. ë¡œê·¸ì¸ì„ í†µí•´ user ì •ë³´ë¥¼ ë°›ì•„ì˜¤ë©´ json í˜•ì‹ìœ¼ë¡œ data ë³€ìˆ˜ì— ì €ì¥ì„ í•œë‹¤.
1-3. ê·¸ëŒ€ë¡œ dataëŸ´ returní•´ë„ ì¢‹ê³  í•„ìš”í•œ ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ê³  ì‹¶ìœ¼ë©´ ìœ„ì™€ ê°™ì´ return í•œë‹¤.


ğŸˆ ë¡œê·¸ì¸ í›„ callbacks ì‹¤í–‰
callbacks: {
  async jwt({ token, user }) {
    // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œì—ë§Œ user ë°ì´í„°ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤
    if (user) {
      // ë°±ì—”ë“œì—ì„œ ë°›ì€ í† í°ì„ JWT í† í°ì— í¬í•¨
      token.accessToken = user.accessToken;
      token.refreshToken = user.refreshToken;
    }
    return token;
  },

  async session({ session, token }) {
    // ì„¸ì…˜ì— accessToken í¬í•¨
    session.accessToken = token.accessToken;
    return session;
  }
}

2-1. ì´í›„ ë¡œê·¸ì¸ì´ ëë‚˜ë©´ callbacksì´ ì‹¤í–‰ì´ ëœë‹¤.
2-2. jwt ì½œë°±ì„ í†µí•´ JWT ìƒì„±ì„ í•˜ëŠ”ë° ì•ì„œ returní•œ data ê°’ì´ userì— ë“¤ì–´ê°„ë‹¤.
2-3. ì´ˆê¸°ì—ëŠ” tokenì´ ë¹„ì–´ìˆìœ¼ë©°, tokenì— accessToken, refreshTokenë¥¼ ì¶”ê°€í•´ë„ ë˜ê³ 
     return {...token, ...user} ì´ë ‡ê²Œ user ê°’ì„ tokenì— ë®ì–´ ì”Œì›Œë„ ëœë‹¤.
2-4. ê·¸ëŸ¼ í•´ë‹¹ tokenì´ session ì½œë°±ì˜ tokenì¸ìë¡œ ë“¤ì–´ê°„ë‹¤.
2-5. ì´ëŠ” ì¿ í‚¤ sessionì— ì €ì¥ ë° ë³€ê²½í•˜ëŠ” ê³¼ì •ì´ë‹¤.
2-6. session.accessTokenì— ì €ì¥í•œ tokenì˜ accessTokenì„ ë„£ì–´ ìˆ˜ì •í•˜ê³  returní•œë‹¤.
2-7. ì—¬ê¸°ì„œ session.accessTokenì´ ì•ˆ ì¡íˆê±°ë‚˜ ë˜ëŠ” userSession()ì—ì„œ accessTokenì´
     ì—†ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë° ì´ëŠ” /types/next-auth.d.ts íŒŒì¼ì„ ìƒì„±ì„ í•˜ê³  ë‹¤ìŒê³¼ ê°™ì´ í•œë‹¤.
      import NextAuth from "next-auth";

      declare module "next-auth" {
        interface Session {
          user: {
            id: number;
            name: string;
            email: string;
            accessToken: string;
          };
        }
      }


ğŸˆ ì´í›„ session í™œìš© ë° accessToken ì‚¬ìš©

âœ¨ Client Component
import { useSession } from "next-auth/react";

function MyComponent() {
  const { data: session } = useSession();

  const fetchData = async () => {
    const response = await fetch('YOUR_API_ENDPOINT', {
      headers: {
        'Authorization': `Bearer ${session?.accessToken}`
      }
    });
    // ...
  };
}

3-1. í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì˜ ì‚¬ìš© ë°©ë²•ì´ë‹¤.
3-2. useSession()í•¨ìˆ˜ë¥¼ í†µí•´ ì¿ í‚¤ì— ì €ì¥ëœ session ê°’ì„ ë¶ˆëŸ¬ì˜¤ê³  accessTokenì´ í•„ìš”í•œ
     APIì— headersì— í† í°ì„ ë‹´ì•„ ìš”ì²­ì„ í•œë‹¤.

âœ¨ Server Component
import { getSession } from "next-auth/react";

async function getData() {
  const session = await getSession();
  const response = await fetch('YOUR_API_ENDPOINT', {
    headers: {
      'Authorization': `Bearer ${session?.accessToken}`
    }
  });
  // ...
}

4-1. ì„œë²„ ì»´í¬ë„ŒíŠ¸ì˜ ì‚¬ìš© ë°©ë²•ì´ë‹¤.
4-2. ì„œë²„ì¸ ê²½ìš°ëŠ” getSession()ì„ í†µí•´ ì„œë²„ì—ì„œ session ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë‹¤.
4-3. session ë°ì´í„° ë°›ì•„ì˜¤ë©´ ë°”ë¡œ headersì— accessTokenì„ ë‹´ì•„ API ìš”ì²­ì„ í•´ì„œ ê°€ì ¸ì˜¨ë‹¤.


âœ¨âœ¨ GoogleProviderë¥¼ í†µí•œ ë¡œê·¸ì¸ (Kakao, Naver ...)
  - ë°±ì—”ë“œ ì„œë²„ì—ì„œ accessToken, refreshToken ì£¼ëŠ” ê²½ìš°

ğŸˆ NextAuth ë¡œê·¸ì¸(GoogleProvider)
GoogleProvider({
  clientId: process.env.GOOGLE_ID,
  clientSecret: process.env.GOOGLE_SECRET,
  callbacks: {
    async signIn({ account, profile }) {
      // accountì—ëŠ” ì†Œì…œ í”Œë«í¼ì˜ access_tokenì´ ìˆìŠµë‹ˆë‹¤
      
      // ë°±ì—”ë“œë¡œ ì†Œì…œ í† í° ì „ë‹¬
      const response = await fetch('YOUR_BACKEND/social-login', {
        method: 'POST',
        body: JSON.stringify({
          provider: 'google',
          token: account.access_token,
          profile: profile
        })
      });

      const data = await response.json();
      // ë°±ì—”ë“œì—ì„œ ìì²´ accessTokenì„ ë°œê¸‰ë°›ìŒ
      account.backendAccessToken = data.accessToken;
      
      return true;
    }
  }
})

1-1. ì†Œì…œ ë¡œê·¸ì¸ êµ¬ê¸€ ë°©ë²•ì´ë‹¤. ì´ëŠ” ì†Œì…œ ë¡œê·¸ì¸ í›„ ë°±ì—”ë“œ ì„œë²„ì—ì„œ accessTokenì„ ì¤¬ì„ ë•Œ ì´ë‹¤.
1-2. ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
      - ìì²´ ì†Œì…œ í† í° ê²€ì¦
      - ì‚¬ìš©ì ì •ë³´ ì €ì¥/ì¡°íšŒ
      - ìì²´ accessToken ë°œê¸‰
1-3. ì†Œì…œ ë¡œê·¸ì¸ APIì—ì„œ ì†Œì…œ í† í°ê³¼, profileì˜ ì •ë³´ë¥¼ ë„˜ê²¨ ë°±ì—”ë“œì—ì„œ ìì²´ ìƒì„±í•œ
     accessTokenì„ ë°œê¸‰ì„ ë°›ê³  ì´í›„ ë˜‘ê°™ì´ callbacks ì‹¤í–‰í•˜ë©´ ëœë‹¤.
1-4. ì—¬ê¸°ì„œ profileì€ ì†Œì…œì˜ googleì´ ì£¼ëŠ” ì •ë³´ì´ì—¬ ë‹¤ë¥¸ í”Œë«í¼ ë§ˆë‹¤ ì°¨ì´ê°€ ìˆë‹¤.
      {
        sub: string          // Googleì˜ ê³ ìœ  ì‚¬ìš©ì ID
        name: string         // ì „ì²´ ì´ë¦„
        given_name: string   // ì´ë¦„
        family_name: string  // ì„±
        email: string        // ì´ë©”ì¼ ì£¼ì†Œ
        picture: string      // í”„ë¡œí•„ ì‚¬ì§„ URL
        email_verified: boolean  // ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€
        locale: string       // ì‚¬ìš©ì ì–¸ì–´ ì„¤ì •
      }



âœ¨âœ¨ í† í° ë§Œë£Œ ì‹œ refreshToken ì‹¤í–‰ ë°©ë²•
callbacks: {
  async jwt({ token, user }) {
    // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ
    if (user) {
      return {
        ...token,
        accessToken: user.accessToken,
        refreshToken: user.refreshToken,
        accessTokenExpires: Date.now() + user.expiresIn * 1000 // ì˜ˆ: 1ì‹œê°„
      }
    }

    // í† í°ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (Date.now() < token.accessTokenExpires) {
      return token;
    }

    // í† í°ì´ ë§Œë£Œë˜ì—ˆë‹¤ë©´ refreshTokenìœ¼ë¡œ ìƒˆë¡œìš´ accessToken ë°œê¸‰
    try {
      const response = await fetch('YOUR_BACKEND/refresh', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          refreshToken: token.refreshToken
        })
      });

      const refreshedTokens = await response.json();

      if (!response.ok) {
        // refreshTokenë„ ë§Œë£Œëœ ê²½ìš°
        throw new Error("RefreshAccessTokenError");
      }

      return {
        ...token,
        accessToken: refreshedTokens.accessToken,
        refreshToken: refreshedTokens.refreshToken ?? token.refreshToken,
        accessTokenExpires: Date.now() + refreshedTokens.expiresIn * 1000
      }
    } catch (error) {
      // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
      return {
        ...token,
        error: "RefreshAccessTokenError"
      }
    }
  },

  async session({ session, token }) {
    session.accessToken = token.accessToken;
    session.error = token.error;
    return session;
  }
}

1-1. ê¸°ì¡´ì—ì„œ ë¡œê·¸ì¸ í›„ jwt ì½œë°±ì—ì„œ 
     accessTokenExpires: Date.now() + user.expiresIn * 1000 ì„ ì¶”ê°€ë¡œ tokenì— ì €ì¥ì„ í•œë‹¤.
1-2. ì¡°ê±´ì„ í†µí•´ í˜„ì¬ ì‹œê°„ê³¼ accessTokenExpiresì˜ ì‹œê°„ì„ ë¹„êµë¥¼ í•˜ê³  ì•„ì§ ë§Œë£Œê°€ ë˜ì§€ ì•Šìœ¼ë©´
     ê¸°ì¡´ tokenì„ ì‚¬ìš©ì„ í•˜ê³  ë§Œë£Œê°€ ë˜ë©´ refresh()í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì„ í•œë‹¤.
1-3. ì—¬ê¸°ì„œ ì•ì„œ ë¡œê·¸ì¸ì„ í•˜ë©´ì„œ refreshTokenë„ ë°›ì€ ê°’ì„ API ìš”ì²­ì— ê°™ì´ ë„£ì–´ ë°›ì•„ì˜¤ê³ 
1-4. ê¸°ì¡´ tokenì—ì„œ accessToken, refreshToken, accessTokenExpires ìˆ˜ì •ì„ í•˜ê³ 
     session ì—…ë°ì´íŠ¸ë¥¼ í•´ì¤€ë‹¤.
     

ë°±ì—”ë“œì—ì„œ ì–´ë–»ê²Œ ë™ì‘ì„ í•˜ëŠ”ì§€ ìì„¸íˆ ëª¨ë¥´ì§€ë§Œ í”„ë¡ íŠ¸ì—ì„œ NextAuthë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.
authOptionì„ í†µí•´ ì¢€ë” í˜ì´ì§€ì— ëŒ€í•œ ë¡œê·¸ì¸ ê´€ë¦¬ë¥¼ í•´ì¤„ ìˆ˜ ìˆë‹¤.

page routerì—ì„œ í† í° ê´€ë¦¬ë¥¼ _app.tsx ì»´í¬ë„ŒíŠ¸ì—ì„œ ì„œë²„ ìƒíƒœê´€ë¦¬(ApolloClient)ë¥¼ í†µí•´ ì €ì¥ ë°
refreshToken ìš”ì²­ì„ í–ˆìœ¼ë©° ë³µì¡í•¨ì´ ìˆë‹¤.

refreshToken ê°™ì€ ê²½ìš°ëŠ” í”„ë¡ íŠ¸ì—ì„œ ì„¤ì •í•  ê±°ëŠ” ë”°ë¡œ ì—†ê³  ë°±ì—”ë“œì—ì„œ httpOnlyì™€ secureë¥¼
ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ì— ì €ì¥ì„ í•´ì£¼ê³ 
í”„ë¡ íŠ¸ì—ì„œëŠ” refreshToken í•¨ìˆ˜ ìš”ì²­ ì‹œ credentials: "include" ì˜µì…˜ìœ¼ë¡œ ì¿ í‚¤ í¬í•¨í•´ì„œ
ìš”ì²­í•˜ë©´ ëœë‹¤.

const response = await fetch('/api/refresh-token', {
  method: 'POST',
  credentials: 'include', // ì¿ í‚¤ í¬í•¨
});

ğŸ‰ ë³€ê²½ ì „
const response = await fetch('YOUR_BACKEND/refresh', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    refreshToken: token.refreshToken
  })
});

ğŸ‰ ë³€ê²½ í›„
const response = await fetch('YOUR_BACKEND/refresh', {
  method: 'POST',
  credentials: 'include', // ì¿ í‚¤ í¬í•¨
  headers: {
    'Content-Type': 'application/json',
  },
});

refreshTokenì„ ì¿ í‚¤ì˜ httpOnlyì™€ secureë¥¼ í†µí•´ ì €ì¥ì„ í–ˆë‹¤ë©´ 
ì¿ í‚¤ í¬í•¨í•´ì„œ ìš”ì²­ì„ í•˜ë©´ bodyì˜ refreshedTokensê°€ í•„ìš”ì—†ê³ 
API ìš”ì²­ì— ì¿ í‚¤ í¬í•¨í•´ì„œ ì „ë‹¬í•´ì£¼ëŠ” credentials: "include", ì˜µì…˜ì„ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ ë³´ì•ˆì— ì¢‹ì€ ê²°ê³¼ë¥¼ ì¤€ë‹¤.